name: 持续集成
run-name: ${{ github.actor }} 正在运行CI检查 🔍

on:
  push:
    branches: [ master, develop ]
  pull_request:
    branches: [ master, develop ]

jobs:
  # 基础构建和测试
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: 缓存NuGet包
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/packages.lock.json') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: 恢复依赖
        run: dotnet restore

      - name: 构建项目
        run: dotnet build --no-restore --configuration Release

      - name: 运行测试
        run: dotnet test --no-build --configuration Release --verbosity normal

  # 简化的AOT编译测试 (仅Linux)
  aot-test:
    runs-on: ubuntu-latest
    needs: test  # 只有基础测试通过后才运行AOT测试

    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: 安装Linux依赖
        run: |
          sudo apt-get update
          sudo apt-get install -y clang zlib1g-dev

      - name: 恢复依赖
        run: dotnet restore

      - name: AOT编译测试
        run: dotnet publish src/PdfTocExtractor.Cli/PdfTocExtractor.Cli.csproj -c Release -r linux-x64 --self-contained true -p:PublishAot=true -o ./test-publish

      - name: 测试可执行文件
        run: ./test-publish/pdftoc --help
