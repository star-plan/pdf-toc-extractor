name: æŒç»­é›†æˆ
run-name: ${{ github.actor }} æ­£åœ¨è¿è¡ŒCIæ£€æŸ¥ ğŸ”

on:
  push:
    branches: [ master, develop ]
  pull_request:
    branches: [ master, develop ]

jobs:
  # åŸºç¡€æ„å»ºå’Œæµ‹è¯•
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: ç¼“å­˜NuGetåŒ…
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/packages.lock.json') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: æ¢å¤ä¾èµ–
        run: dotnet restore

      - name: æ„å»ºé¡¹ç›®
        run: dotnet build --no-restore --configuration Release

      - name: è¿è¡Œæµ‹è¯•
        run: dotnet test --no-build --configuration Release --verbosity normal

  # ç®€åŒ–çš„AOTç¼–è¯‘æµ‹è¯• (ä»…Linux)
  aot-test:
    runs-on: ubuntu-latest
    needs: test  # åªæœ‰åŸºç¡€æµ‹è¯•é€šè¿‡åæ‰è¿è¡ŒAOTæµ‹è¯•

    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: å®‰è£…Linuxä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y clang zlib1g-dev

      - name: æ¢å¤ä¾èµ–
        run: dotnet restore

      - name: AOTç¼–è¯‘æµ‹è¯•
        run: dotnet publish src/PdfTocExtractor.Cli/PdfTocExtractor.Cli.csproj -c Release -r linux-x64 --self-contained true -p:PublishAot=true -o ./test-publish

      - name: æµ‹è¯•å¯æ‰§è¡Œæ–‡ä»¶
        run: ./test-publish/pdftoc --help
